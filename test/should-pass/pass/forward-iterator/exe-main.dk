// -*- mode: Dakota; c-basic-offset: 2; tab-width: 2; indent-tabs-mode: nil -*-

# include <stdio.h>
# include <assert.h>

klass deque;
klass hashed-counted-set;
klass hashed-set;
klass pair;
klass sorted-counted-set;
klass sorted-set;
klass uint32;
klass vector;

static void check-for(object-t collection) {
  uint32-t size = $size(collection);
  printf("%i[", size);
  char8-t* delim = "";
  for (object-t iter = $forward-iterator(collection);
       $next?(iter);
       $next(iter)) {
    object-t e = $element(iter);
    object-t key = e;
    if ($instance?(key, pair::klass))
      key = pair::unbox(key)->first;
    printf("%s%i", delim, *uint32::unbox(key));
    delim = ",";
  }
  printf("]");
  return;
}

static void check-for-each(object-t collection) {
  printf("%i[", $size(collection));
  char8-t* delim = "";
  for (object-t e in collection) {
    object-t key = e;
    if ($instance?(key, pair::klass))
      key = pair::unbox(key)->first;
    printf("%s%i", delim, *uint32::unbox(key));
    delim = ",";
  }
  printf("]");
  return;
}

static const uint32-t count = 3;

static void check(object-t klass, object-t (*add)(object-t, object-t), void (*check-for-func)(object-t)) {
  object-t c = make(klass);
  char8-t* delim = "";

  for (uint32-t i = 0; i < count; i++) {
    printf("%s", delim);
    delim = ", ";
    check-for-func(c);
    add(c, uint32::box(i));
    check-for-func(c);
  }
  printf("\n");
  return;
}

static void check(object-t klass, object-t (*add)(object-t, object-t)) {
  check(klass, add, check-for-each);
  check(klass, add, check-for);
  return;
}

int-t main() {
  check(vector::klass, $add-last);
  check(deque::klass,  $add-last);
  check(sorted-set::klass, $add);
  check(hashed-set::klass, $add);

  check(sorted-counted-set::klass, $add);
  check(hashed-counted-set::klass, $add);

  return 0;
}
